<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings - Unitrade</title>
    <link rel="icon" type="image/png" href="./images/app_logo.png">
    <link rel="shortcut icon" type="image/png" href="./images/app_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, rgba(0, 77, 64, 0.08) 0%, rgba(20, 184, 166, 0.1) 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="./images/app_logo.png" alt="Unitrade" class="h-10 w-10 mr-3">
                    <span class="text-2xl font-bold text-teal-800">Unitrade</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="buyer-dashboard.html" class="text-gray-600 hover:text-teal-600">
                        <i class="fas fa-home mr-1"></i>
                        Dashboard
                    </a>
                    <button onclick="logout()" class="text-gray-600 hover:text-teal-600">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Profile Settings</h1>
            <p class="text-gray-600 mt-2">Manage your account information and preferences</p>
        </div>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Profile Picture Section -->
            <div class="md:col-span-1">
                <div class="glass-effect rounded-3xl p-6 shadow-xl">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Profile Picture</h3>
                    <div class="text-center">
                        <div class="relative inline-block">
                            <img id="profileImage" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjY0IiBjeT0iNDgiIHI9IjI0IiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yNCA5NkM0OCA3MiA3MiA2NCA5NiA2NFMxNDQgNzIgMTY4IDk2VjEyOEgyNFY5NloiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+" alt="Profile" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-4 border-white shadow-lg">
                            <label for="imageUpload" class="absolute bottom-0 right-0 bg-teal-600 text-white rounded-full p-2 cursor-pointer hover:bg-teal-700 transition duration-200">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        </div>
                        <p class="text-sm text-gray-500">Click to change profile picture</p>
                    </div>
                </div>
            </div>

            <!-- Settings Form -->
            <div class="md:col-span-2">
                <div class="glass-effect rounded-3xl p-8 shadow-xl">
                    <form id="profileForm">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user text-teal-600 mr-2"></i>
                                    Full Name
                                </label>
                                <input type="text" id="fullName" name="fullName" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                            </div>

                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-envelope text-teal-600 mr-2"></i>
                                    Email Address
                                </label>
                                <input type="email" id="email" name="email" readonly
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100 text-gray-500">
                                <p class="text-sm text-gray-500 mt-1">Email cannot be changed</p>
                            </div>

                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-phone text-teal-600 mr-2"></i>
                                    Phone Number
                                </label>
                                <input type="tel" id="phone" name="phone" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                            </div>

                            <div>
                                <label for="university" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-university text-teal-600 mr-2"></i>
                                    University
                                </label>
                                <select id="university" name="university" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                                    <option value="">Select your university</option>
                                    <option value="university-of-ghana">University of Ghana</option>
                                    <option value="knust">Kwame Nkrumah University of Science and Technology</option>
                                    <option value="university-of-cape-coast">University of Cape Coast</option>
                                    <option value="university-of-education">University of Education, Winneba</option>
                                    <option value="ashesi-university">Ashesi University</option>
                                    <option value="central-university">Central University</option>
                                    <option value="presbyterian-university">Presbyterian University</option>
                                    <option value="valley-view-university">Valley View University</option>
                                    <option value="methodist-university">Methodist University</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div id="studentIdField">
                                <label for="studentId" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-id-card text-teal-600 mr-2"></i>
                                    Student ID
                                </label>
                                <input type="text" id="studentId" name="studentId"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                            </div>

                            <div id="usernameField" style="display: none;">
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-at text-teal-600 mr-2"></i>
                                    Username
                                </label>
                                <input type="text" id="username" name="username"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                            </div>

                            <div id="schoolIdField" style="display: none;">
                                <label for="schoolId" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-graduation-cap text-teal-600 mr-2"></i>
                                    School ID
                                </label>
                                <input type="text" id="schoolId" name="schoolId"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                            </div>

                            <div id="hostelField" style="display: none;">
                                <label for="hostel" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-home text-teal-600 mr-2"></i>
                                    Hostel
                                </label>
                                <input type="text" id="hostel" name="hostel"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                            </div>
                        </div>

                        <div class="mt-8 flex justify-end space-x-4">
                            <button type="button" onclick="cancelChanges()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition duration-200">
                                Cancel
                            </button>
                            <button type="submit" class="px-6 py-3 bg-teal-600 text-white rounded-xl hover:bg-teal-700 transition duration-200">
                                <i class="fas fa-save mr-2"></i>
                                Save Changes
                            </button>
                        </div>
                    </form>

                    <!-- Change Password Section -->
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6">
                            <i class="fas fa-key text-teal-600 mr-2"></i>
                            Change Password
                        </h3>
                        <form id="passwordForm">
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-lock text-teal-600 mr-2"></i>
                                        Current Password
                                    </label>
                                    <input type="password" id="currentPassword" name="currentPassword" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                                </div>

                                <div>
                                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-key text-teal-600 mr-2"></i>
                                        New Password
                                    </label>
                                    <input type="password" id="newPassword" name="newPassword" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                                </div>

                                <div>
                                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-check-circle text-teal-600 mr-2"></i>
                                        Confirm New Password
                                    </label>
                                    <input type="password" id="confirmPassword" name="confirmPassword" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                                </div>

                                <div class="flex items-end">
                                    <button type="submit" class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition duration-200">
                                        <i class="fas fa-key mr-2"></i>
                                        Change Password
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, createUserWithEmailAndPassword, sendEmailVerification, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzyKtEKbUMt66t9Sfk_onbOcJNic_t5oc",
            authDomain: "unitrade-d74e9.firebaseapp.com",
            projectId: "unitrade-d74e9",
            storageBucket: "unitrade-d74e9.firebasestorage.app",
            messagingSenderId: "619229942843",
            appId: "1:619229942843:web:8eced8b46057a24b04f81e",
            measurementId: "G-6DPM2BCY97"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (!user.emailVerified) {
                    alert('Please verify your email before accessing the dashboard.');
                    window.location.href = 'email-verification.html';
                    return;
                }
                currentUser = user;
                await loadUserData();
            } else {
                window.location.href = 'buyer-login.html';
            }
        });

        // Load user data
        window.loadUserData = async function() {
            try {
                // Get all users from database
                const usersRef = collection(db, 'users');
                const allUsersSnapshot = await getDocs(usersRef);
                
                let foundUser = null;
                let foundDoc = null;
                
                // Check each user document for a match
                allUsersSnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Check if this is our user - try multiple matching methods
                    let isMatch = false;
                    
                    // Method 1: Exact email match
                    if (data.email === currentUser.email) {
                        isMatch = true;
                    }
                    
                    // Method 2: UID match
                    if (data.uid === currentUser.uid) {
                        isMatch = true;
                    }
                    
                    // Method 3: Check if the document ID is the UID
                    if (doc.id === currentUser.uid) {
                        isMatch = true;
                    }
                    
                    // Method 4: Check if displayName matches (fallback)
                    if (data.fullName && currentUser.displayName && 
                        data.fullName.toLowerCase() === currentUser.displayName.toLowerCase()) {
                        isMatch = true;
                    }
                    
                    if (isMatch) {
                        foundUser = data;
                        foundDoc = doc;
                    }
                });
                
                if (foundUser && foundDoc) {
                    userData = foundUser;
                    userData.id = foundDoc.id;
                    
                    // Populate form fields
                    document.getElementById('fullName').value = userData.fullName || '';
                    document.getElementById('email').value = userData.email || '';
                    document.getElementById('phone').value = userData.phone || '';
                    document.getElementById('university').value = userData.university || '';
                    
                    // Show/hide fields based on user type
                    if (userData.userType === 'buyer') {
                        document.getElementById('studentIdField').style.display = 'block';
                        document.getElementById('studentId').value = userData.studentId || '';
                    } else if (userData.userType === 'seller') {
                        document.getElementById('usernameField').style.display = 'block';
                        document.getElementById('schoolIdField').style.display = 'block';
                        document.getElementById('hostelField').style.display = 'block';
                        document.getElementById('username').value = userData.username || '';
                        document.getElementById('schoolId').value = userData.schoolID || '';
                        document.getElementById('hostel').value = userData.hostel || '';
                    }
                } else {
                    if (allUsersSnapshot.size === 0) {
                        alert('No users found in database. Please complete your registration first.');
                    } else {
                        alert('User data not found. Please complete your registration first.');
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Error loading user data: ' + error.message);
            }
        }

        // Profile image upload
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });


        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const updatedData = {
                fullName: formData.get('fullName'),
                phone: formData.get('phone'),
                university: formData.get('university'),
                updatedAt: new Date()
            };

            // Add user type specific fields
            if (userData.userType === 'buyer') {
                updatedData.studentId = formData.get('studentId');
            } else if (userData.userType === 'seller') {
                updatedData.username = formData.get('username');
                updatedData.schoolID = formData.get('schoolId');
                updatedData.hostel = formData.get('hostel');
            }

            try {
                const userDocRef = doc(db, 'users', userData.id);
                await updateDoc(userDocRef, updatedData);
                
                // Update Firebase Auth display name
                await updateProfile(currentUser, {
                    displayName: updatedData.fullName
                });
                
                alert('Profile updated successfully!');
                location.reload();
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        });

        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long!');
                return;
            }
            
            try {
                // Re-authenticate user
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                
                // Update password
                await updatePassword(currentUser, newPassword);
                
                alert('Password changed successfully!');
                document.getElementById('passwordForm').reset();
            } catch (error) {
                console.error('Error changing password:', error);
                let errorMessage = 'Error changing password. Please try again.';
                
                switch (error.code) {
                    case 'auth/wrong-password':
                        errorMessage = 'Current password is incorrect.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'New password is too weak.';
                        break;
                }
                
                alert(errorMessage);
            }
        });

        // Cancel changes
        function cancelChanges() {
            if (confirm('Are you sure you want to cancel? All unsaved changes will be lost.')) {
                loadUserData();
            }
        }


        // Logout function
        window.logout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }
    </script>
</body>
</html>
