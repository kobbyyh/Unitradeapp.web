<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Buyer Dashboard - Unitrade</title>
    <script src="js/firebase-config-public.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <h1 class="text-2xl font-bold mb-4">Debug Buyer Dashboard</h1>
    <div id="status" class="mb-4 p-4 bg-blue-100 rounded">Loading...</div>
    <div id="productsContainer" class="grid md:grid-cols-3 gap-6">
        <div class="col-span-full text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Loading products...</p>
        </div>
    </div>
    
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, orderBy, limit, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        console.log('üîç Starting debug session...');
        
        // Main initialization function
        async function initializeApp() {
            console.log('üîç Initializing app...');
            
            // Firebase configuration - Load from public config
            const firebaseConfig = window.FIREBASE_CONFIG;
            console.log('üîç Firebase config:', firebaseConfig);

            // Initialize Firebase safely
            let app, auth, db;
            try {
                const firebaseInit = await window.initializeFirebase(firebaseConfig);
                app = firebaseInit.app;
                auth = firebaseInit.auth;
                db = firebaseInit.db;
                console.log('‚úÖ Firebase initialized successfully');
                document.getElementById('status').innerHTML = '‚úÖ Firebase initialized successfully';
            } catch (error) {
                console.error('‚ùå Firebase initialization failed:', error);
                document.getElementById('status').innerHTML = '‚ùå Firebase initialization failed: ' + error.message;
                return;
            }

            // Check if Firebase initialized successfully
            if (!auth || !db) {
                console.error('‚ùå Firebase not initialized properly');
                document.getElementById('status').innerHTML = '‚ùå Firebase not initialized properly';
                return;
            }

            // Test loading products without authentication
            console.log('üîç Testing product loading...');
            await loadProducts(db);
        }

        // Load products from Firestore
        async function loadProducts(db) {
            try {
                console.log('üîÑ Loading products from Firestore...');
                document.getElementById('status').innerHTML = 'üîÑ Loading products from Firestore...';
                
                // Load all items first without filters to see what's in the database
                const productsRef = collection(db, 'items');
                console.log('üîç Products collection reference:', productsRef);
                
                const allItemsSnapshot = await getDocs(productsRef);
                console.log('üìä Total items in database:', allItemsSnapshot.size);
                document.getElementById('status').innerHTML = `üìä Found ${allItemsSnapshot.size} items in database`;
                
                const productsContainer = document.getElementById('productsContainer');
                productsContainer.innerHTML = '';

                if (allItemsSnapshot.empty) {
                    console.log('‚ùå No items found in database');
                    document.getElementById('status').innerHTML = '‚ùå No items found in database';
                    productsContainer.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">No items available</h3>
                            <p class="text-gray-500">Check back later for new listings!</p>
                        </div>
                    `;
                    return;
                }

                // Log all items to see their structure
                console.log('üîç All items in database:');
                allItemsSnapshot.forEach((doc) => {
                    const product = doc.data();
                    console.log('üì¶ Item:', doc.id, product);
                });

                // Filter items manually for now
                const availableItems = [];
                allItemsSnapshot.forEach((doc) => {
                    const product = doc.data();
                    console.log('üîç Checking item:', doc.id, 'isAvailable:', product.isAvailable, 'isSold:', product.isSold);
                    // Check if item is available and not sold
                    if (product.isAvailable !== false && product.isSold !== true) {
                        availableItems.push({ id: doc.id, ...product });
                        console.log('‚úÖ Item added to available list:', doc.id);
                    } else {
                        console.log('‚ùå Item filtered out:', doc.id, 'isAvailable:', product.isAvailable, 'isSold:', product.isSold);
                    }
                });

                console.log('üìä Available items after filtering:', availableItems.length);
                document.getElementById('status').innerHTML = `üìä Found ${availableItems.length} available items after filtering`;

                if (availableItems.length === 0) {
                    console.log('‚ùå No available items found after filtering');
                    document.getElementById('status').innerHTML = '‚ùå No available items found after filtering';
                    productsContainer.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">No available items</h3>
                            <p class="text-gray-500">All items are sold or unavailable</p>
                        </div>
                    `;
                    return;
                }

                // Display the available items
                console.log('üîÑ Displaying available items...');
                availableItems.forEach((product, index) => {
                    console.log(`üì¶ Processing product ${index + 1}:`, product);
                    const productCard = createProductCard(product, product.id);
                    productsContainer.appendChild(productCard);
                });
                
                console.log('‚úÖ Products loaded successfully');
                document.getElementById('status').innerHTML = `‚úÖ Successfully loaded ${availableItems.length} products`;
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                document.getElementById('status').innerHTML = '‚ùå Error loading products: ' + error.message;
                const productsContainer = document.getElementById('productsContainer');
                productsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Error loading products</h3>
                        <p class="text-gray-500">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Create product card
        function createProductCard(product, productId) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition duration-300 cursor-pointer';
            card.onclick = () => window.location.href = `product-details.html?id=${productId}`;
            
            // Handle images
            let imageHtml = '';
            if (product.imageUrls && product.imageUrls.length > 0) {
                imageHtml = `<img src="${product.imageUrls[0]}" alt="${product.title}" class="w-full h-48 object-cover rounded-lg mb-4">`;
            } else if (product.imageUrl) {
                imageHtml = `<img src="${product.imageUrl}" alt="${product.title}" class="w-full h-48 object-cover rounded-lg mb-4">`;
            } else {
                imageHtml = `<div class="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center"><i class="fas fa-image text-4xl text-gray-400"></i></div>`;
            }
            
            card.innerHTML = `
                ${imageHtml}
                <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.title || 'Untitled Item'}</h3>
                <p class="text-sm text-gray-500 mb-2">${product.category || 'Uncategorized'}</p>
                <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description || 'No description available'}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold text-teal-600">GHS ${product.price || 0}</span>
                    <span class="text-sm text-gray-500">${product.paymentMethod || 'Momo'}</span>
                </div>
                <div class="mt-2 text-xs text-gray-400">
                    <p>isAvailable: ${product.isAvailable}</p>
                    <p>isSold: ${product.isSold}</p>
                </div>
            `;
            
            return card;
        }

        // Start the application
        initializeApp();
    </script>
</body>
</html>
