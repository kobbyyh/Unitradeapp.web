<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard - Unitrade</title>
    <link rel="icon" type="image/png" href="./images/app_logo.png">
    <link rel="shortcut icon" type="image/png" href="./images/app_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="js/unified-notification-service.js"></script>
    <!-- Firebase SDK -->
    <script src="js/firebase-config-public.js"></script>
    <script src="js/firebase-init.js"></script>
    
    <!-- Global Functions -->
    <script>
        // Mobile menu toggle function
        window.toggleMobileMenu = function() {
            console.log('Mobile menu toggle clicked');
            const mobileMenu = document.getElementById('mobileMenu');
            if (!mobileMenu) {
                console.error('Mobile menu element not found');
                return;
            }
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.style.display = 'block';
                console.log('Mobile menu shown');
            } else {
                mobileMenu.classList.add('hidden');
                mobileMenu.style.display = 'none';
                console.log('Mobile menu hidden');
            }
        }

        // Logout function
        window.logout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    // Get auth from the module
                    if (window.auth) {
                        await window.auth.signOut();
                        window.location.href = 'index.html';
                    } else {
                        console.error('Auth not available');
                    }
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }
    </script>
    
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, orderBy, limit, addDoc, updateDoc, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration - Load from public config
        const firebaseConfig = window.FIREBASE_CONFIG;

        // Initialize Firebase safely
        let app, auth, db;
        try {
            const firebaseInit = await window.initializeFirebase(firebaseConfig);
            app = firebaseInit.app;
            auth = firebaseInit.auth;
            db = firebaseInit.db;
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            alert('Failed to initialize Firebase. Please refresh the page.');
            // Don't return here, just set auth and db to null
            auth = null;
            db = null;
        }

        // Check if Firebase initialized successfully
        if (!auth || !db) {
            console.error('Firebase not initialized properly');
            return;
        }

        let currentUser = null;


        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('User is signed in:', user);
                
                // Check if email is verified
                if (!user.emailVerified) {
                    alert('Please verify your email before accessing the dashboard. Check your inbox for the verification link.');
                    window.location.href = 'email-verification.html';
                    return;
                }
                
                currentUser = user;
                loadUserData(user);
                loadSellerStats();
                loadSellerProducts();
                loadNotificationCount(user.uid);
            } else {
                console.log('User is signed out');
                window.location.href = 'seller-login.html';
            }
        });

        // Load user data
        async function loadUserData(user) {
            document.getElementById('userEmail').textContent = user.email;
            
            // Get user data from Firestore to get the actual name
            try {
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', user.email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0].data();
                    const fullName = userDoc.fullName || user.displayName || 'Seller';
                    const firstName = fullName.split(' ')[0]; // Extract first name
                    document.getElementById('userName').textContent = firstName;
                } else {
                    const displayName = user.displayName || 'Seller';
                    const firstName = displayName.split(' ')[0]; // Extract first name
                    document.getElementById('userName').textContent = firstName;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('userName').textContent = user.displayName || 'Seller';
            }
        }

        // Load seller statistics
        async function loadSellerStats() {
            try {
                const productsRef = collection(db, 'items');
                const q = query(productsRef, where('sellerId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                let totalItems = 0;
                let totalSales = 0;
                let activeItems = 0;
                let soldItems = 0;
                let categoryStats = {};

                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    totalItems++; // Total items includes all items (sold + active)
                    
                    if (product.isAvailable && !product.isSold) {
                        activeItems++; // Active items are only non-sold items
                    }
                    
                    if (product.isSold) {
                        soldItems++;
                        totalSales += product.price;
                    }
                    
                    // Category statistics
                    const category = product.category || 'Uncategorized';
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                });


                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalSales').textContent = 'GHS ' + totalSales.toFixed(2);
                document.getElementById('activeItems').textContent = activeItems;
                
                // Update additional analytics
                document.getElementById('soldItems').textContent = soldItems;
                
                // Update category breakdown
                updateCategoryBreakdown(categoryStats);
            } catch (error) {
                console.error('Error loading stats:', error);
                // Show default stats
                document.getElementById('totalItems').textContent = '0';
                document.getElementById('totalSales').textContent = 'GHS 0.00';
                document.getElementById('activeItems').textContent = '0';
            }
        }

        // Load seller products
        async function loadSellerProducts() {
            try {
                console.log('Loading seller products for user:', currentUser.uid);
                const productsRef = collection(db, 'items');
                const q = query(productsRef, where('sellerId', '==', currentUser.uid), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                
                console.log('Found', querySnapshot.size, 'items for seller');
                
                const productsContainer = document.getElementById('productsTableBody');
                productsContainer.innerHTML = '';

                if (querySnapshot.empty) {
                    console.log('No items found for this seller');
                    productsContainer.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">
                                <i class="fas fa-box-open text-4xl mb-2 block"></i>
                                No items posted yet. <a href="seller-post-item.html" class="text-teal-600 hover:text-teal-700">Post your first item!</a>
                            </td>
                        </tr>
                    `;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const product = doc.data();
                    console.log('Processing seller product:', product);
                    const productRow = createProductRow(product, doc.id);
                    productsContainer.appendChild(productRow);
                });
                
                console.log('Seller products loaded successfully');
            } catch (error) {
                console.error('Error loading seller products:', error);
                const productsContainer = document.getElementById('productsTableBody');
                productsContainer.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-4xl mb-2 block"></i>
                            Error loading products: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Create product row
        function createProductRow(product, productId) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="bg-gray-200 h-10 w-10 rounded-lg flex items-center justify-center mr-3">
                            ${product.imageUrls && product.imageUrls.length > 0 ? 
                                `<img src="${product.imageUrls[0]}" alt="${product.title || product.name}" class="w-full h-full object-cover rounded-lg">` :
                                `<i class="fas fa-image text-gray-400"></i>`
                            }
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${product.title || product.name}</div>
                            <div class="text-sm text-gray-500">${product.category || 'General'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">GHS ${product.price}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${product.isAvailable && !product.isSold ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${product.isAvailable && !product.isSold ? 'Available' : 'Sold'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${product.isSold ? 
                        '<span class="text-green-600 font-semibold">Sold</span>' : 
                        '<button onclick="markAsSold(\'' + productId + '\')" class="text-green-600 hover:text-green-900 mr-3">Mark as Sold</button>'
                    }
                    <button onclick="deleteProduct('${productId}')" class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            `;
            return row;
        }


        // Mark product as sold
        window.markAsSold = async function(productId) {
            if (confirm('Are you sure you want to mark this item as sold?')) {
                try {
                    // Update the product in Firestore
                    await updateDoc(doc(db, 'items', productId), {
                        isSold: true,
                        soldAt: new Date()
                    });
                    
                    // Reload the products and stats
                    loadSellerProducts();
                    loadSellerStats();
                    
                    alert('Item marked as sold successfully!');
                } catch (error) {
                    console.error('Error marking item as sold:', error);
                    alert('Error marking item as sold. Please try again.');
                }
            }
        }

        // Delete product
        window.deleteProduct = async function(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await deleteDoc(doc(db, 'items', productId));
                    loadSellerProducts();
                    loadSellerStats();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product. Please try again.');
                }
            }
        }

        // Make auth available globally for logout function
        window.auth = auth;

        // Add new product
        window.addNewProduct = function() {
            window.location.href = 'seller-post-item.html';
        }

        // Update category breakdown
        function updateCategoryBreakdown(categoryStats) {
            const container = document.getElementById('categoryBreakdown');
            
            if (Object.keys(categoryStats).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No categories found</p>';
                return;
            }

            // Sort categories by count
            const sortedCategories = Object.entries(categoryStats)
                .sort(([,a], [,b]) => b - a);

            // Find top category
            const topCategory = sortedCategories[0];
            if (topCategory) {
                document.getElementById('topCategory').textContent = topCategory[0];
            }

            container.innerHTML = sortedCategories.map(([category, count]) => {
                const percentage = (count / Object.values(categoryStats).reduce((a, b) => a + b, 0)) * 100;
                return `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">${category}</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-32 bg-gray-200 rounded-full h-2">
                                <div class="bg-teal-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm text-gray-500 w-8 text-right">${count}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load notification count
        async function loadNotificationCount(sellerId) {
            try {
                const unreadCount = await unifiedNotificationService.getUnreadCount(sellerId);
                const badge = document.getElementById('notificationBadge');
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading notification count:', error);
            }
        }

        // Logout function
        window.logout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }

        // Load real data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Real data is loaded in onAuthStateChanged
        });
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, rgba(0, 77, 64, 0.08) 0%, rgba(20, 184, 166, 0.1) 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="./images/app_logo.png" alt="Unitrade" class="h-10 w-10 mr-3">
                    <span class="text-2xl font-bold text-teal-800">Unitrade</span>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="seller-dashboard.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-1"></i>Dashboard
                    </a>
                    <a href="seller-my-listings.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-list mr-1"></i>My Listings
                    </a>
                    <a href="seller-profile-settings.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-user-cog mr-1"></i>Profile
                    </a>
                    <a href="seller-notifications-dashboard.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium relative">
                        <i class="fas fa-bell mr-1"></i>Notifications
                        <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </a>
                    <button onclick="logout()" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-gray-700 hover:text-teal-600 p-2 rounded-md transition-colors duration-200 hover:bg-gray-100">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden transition-all duration-300 ease-in-out">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white/95 backdrop-blur-md rounded-lg mt-2 shadow-xl border border-gray-200">
                    <a href="seller-dashboard.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="seller-my-listings.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-list mr-2"></i>My Listings
                    </a>
                    <a href="seller-profile-settings.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-user-cog mr-2"></i>Profile
                    </a>
                    <a href="seller-notifications-dashboard.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium relative">
                        <i class="fas fa-bell mr-2"></i>Notifications
                        <span id="mobileNotificationBadge" class="absolute top-2 right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </a>
                    <button onclick="logout()" class="text-gray-700 hover:text-teal-600 block w-full text-left px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome back, <span id="userName">Seller</span>!</h1>
            <p class="text-gray-600">Manage your listings and track your sales</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="bg-teal-100 p-3 rounded-lg">
                        <i class="fas fa-box text-2xl text-teal-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Items</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalItems">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <i class="fas fa-dollar-sign text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Sales</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalSales">GHS 0.00</p>
                    </div>
                </div>
            </div>

            
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <i class="fas fa-star text-2xl text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Active Items</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeItems">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Analytics -->
        <div class="grid md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="bg-red-100 p-3 rounded-lg">
                        <i class="fas fa-check-circle text-2xl text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Items Sold</p>
                        <p class="text-2xl font-bold text-gray-900" id="soldItems">0</p>
                    </div>
                </div>
            </div>



            <div class="bg-white rounded-xl p-6 shadow-lg">
                <div class="flex items-center">
                    <div class="bg-pink-100 p-3 rounded-lg">
                        <i class="fas fa-tags text-2xl text-pink-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Top Category</p>
                        <p class="text-sm font-bold text-gray-900" id="topCategory">None</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Category Breakdown</h3>
            <div id="categoryBreakdown" class="space-y-2">
                <p class="text-gray-500 text-center">Loading categories...</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <button onclick="window.location.href='seller-post-item.html'" class="bg-teal-600 hover:bg-teal-700 text-white p-6 rounded-xl text-left transition duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-plus text-2xl mb-2"></i>
                    <h3 class="font-semibold text-lg">Add New Item</h3>
                    <p class="text-teal-100">List a new item for sale</p>
                </button>

                <button onclick="window.location.href='seller-my-listings.html'" class="bg-white hover:bg-gray-50 text-gray-900 p-6 rounded-xl text-left transition duration-300 shadow-lg hover:shadow-xl border-2 border-teal-600">
                    <i class="fas fa-edit text-2xl mb-2 text-teal-600"></i>
                    <h3 class="font-semibold text-lg">Manage Listings</h3>
                    <p class="text-gray-600">Edit or update your items</p>
                </button>

                <button class="bg-white hover:bg-gray-50 text-gray-900 p-6 rounded-xl text-left transition duration-300 shadow-lg hover:shadow-xl border-2 border-teal-600">
                    <i class="fas fa-chart-line text-2xl mb-2 text-teal-600"></i>
                    <h3 class="font-semibold text-lg">View Analytics</h3>
                    <p class="text-gray-600">Track your performance</p>
                </button>
            </div>
        </div>

        <!-- Recent Listings -->
        <div>
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Your Listings</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
