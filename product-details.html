<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - Unitrade</title>
    <link rel="icon" type="image/png" href="./images/app_logo.png">
    <link rel="shortcut icon" type="image/png" href="./images/app_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="js/firebase-notification-service.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, rgba(0, 77, 64, 0.08) 0%, rgba(20, 184, 166, 0.1) 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .product-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
        }
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .thumbnail.active {
            border-color: #0d9488;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="./images/app_logo.png" alt="Unitrade" class="h-10 w-10 mr-3">
                    <span class="text-2xl font-bold text-teal-800">Unitrade</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="buyer-dashboard.html" class="text-gray-600 hover:text-teal-600">
                        <i class="fas fa-home mr-1"></i>
                        Dashboard
                    </a>
                    <a href="profile-settings.html" class="text-gray-600 hover:text-teal-600">
                        <i class="fas fa-user-cog mr-1"></i>
                        Profile
                    </a>
                    <button onclick="logout()" class="text-gray-600 hover:text-teal-600">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Back Button -->
        <div class="mb-6">
            <button onclick="goBack()" class="flex items-center text-teal-600 hover:text-teal-700">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Dashboard
            </button>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Product Images -->
            <div class="glass-effect rounded-3xl p-6 shadow-xl">
                <div class="mb-4">
                    <img id="mainImage" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNzUgMTUwSDIyNVYyNTBIMTc1VjE1MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE3NSAxNzVIMjI1VjIwMEgxNzVWMTc1WiIgZmlsbD0iI0U1RTdFQiIvPgo8L3N2Zz4K" alt="Product" class="product-image">
                </div>
                <div id="thumbnailContainer" class="flex space-x-2 overflow-x-auto">
                    <!-- Thumbnails will be populated here -->
                </div>
            </div>

            <!-- Product Details -->
            <div class="space-y-6">
                <div class="glass-effect rounded-3xl p-6 shadow-xl">
                    <div class="flex items-start justify-between mb-4">
                        <h1 id="productName" class="text-2xl font-bold text-gray-900">Product Name</h1>
                        <div class="flex items-center space-x-2">
                            <span id="urgentBadge" class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full hidden">
                                Urgent
                            </span>
                            <span id="negotiableBadge" class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full hidden">
                                Negotiable
                            </span>
                        </div>
                    </div>
                    
                    <div class="text-3xl font-bold text-teal-600 mb-4">
                        GHS <span id="productPrice">0.00</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <span class="text-sm text-gray-500">Category</span>
                            <p id="productCategory" class="font-medium">Electronics</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">Condition</span>
                            <p id="productCondition" class="font-medium">Good</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">Location</span>
                            <p id="productLocation" class="font-medium">University of Ghana</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">Views</span>
                            <p id="productViews" class="font-medium">0</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Description</h3>
                        <p id="productDescription" class="text-gray-700 leading-relaxed">
                            Product description will be loaded here...
                        </p>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="placeOrder()" class="flex-1 bg-teal-600 text-white py-3 px-6 rounded-xl hover:bg-teal-700 transition duration-200">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            Place Order
                        </button>
                        <button onclick="addToFavorites()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition duration-200">
                            <i class="fas fa-heart mr-2"></i>
                            Save
                        </button>
                    </div>
                </div>

                <!-- Seller Information -->
                <div class="glass-effect rounded-3xl p-6 shadow-xl">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Seller Information</h3>
                    <div class="flex items-center space-x-4">
                        <img id="sellerAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNGM0Y0RjYiLz4KPGNpcmNsZSBjeD0iMjQiIGN5PSIxOCIgcj0iOCIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMTIgMzZDMiA0MCAyIDQ0IDI0IDQ0UzQ2IDQwIDM2IDM2QzM2IDMwIDMwIDI0IDI0IDI0UzEyIDMwIDEyIDM2WiIgZmlsbD0iIzlDQTNBRiIvPgo8L3N2Zz4K" alt="Seller" class="w-12 h-12 rounded-full">
                        <div>
                            <p id="sellerName" class="font-medium text-gray-900">Seller Name</p>
                            <p id="sellerUniversity" class="text-sm text-gray-500">University of Ghana</p>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-500">Contact Info</span>
                            <p id="contactInfo" class="font-medium">+233 24 123 4567</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">Member Since</span>
                            <p id="memberSince" class="font-medium">2024</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Similar Products -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Similar Products</h2>
            <div id="similarProducts" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Similar products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-900">Contact Seller</h3>
                <button onclick="closeContactModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                    <textarea id="messageText" rows="4" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                              placeholder="Hi! I'm interested in your item..."></textarea>
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="closeContactModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50">
                        Cancel
                    </button>
                    <button onclick="sendMessage()" class="flex-1 bg-teal-600 text-white py-3 px-4 rounded-xl hover:bg-teal-700">
                        Send Message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, increment, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzyKtEKbUMt66t9Sfk_onbOcJNic_t5oc",
            authDomain: "unitrade-d74e9.firebaseapp.com",
            projectId: "unitrade-d74e9",
            storageBucket: "unitrade-d74e9.firebasestorage.app",
            messagingSenderId: "619229942843",
            appId: "1:619229942843:web:8eced8b46057a24b04f81e",
            measurementId: "G-6DPM2BCY97"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentProduct = null;

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (!user.emailVerified) {
                    alert('Please verify your email before accessing the platform.');
                    window.location.href = 'email-verification.html';
                    return;
                }
                currentUser = user;
                loadProductDetails();
            } else {
                window.location.href = 'buyer-login.html';
            }
        });

        // Load product details from URL parameter
        async function loadProductDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            console.log('Loading product details for ID:', productId);
            
            if (!productId) {
                console.log('No product ID found in URL');
                alert('Product not found');
                window.location.href = 'buyer-dashboard.html';
                return;
            }

            try {
                console.log('Fetching product from Firestore...');
                const productDoc = await getDoc(doc(db, 'items', productId));
                
                if (!productDoc.exists()) {
                    console.log('Product document does not exist');
                    alert('Product not found');
                    window.location.href = 'buyer-dashboard.html';
                    return;
                }

                currentProduct = productDoc.data();
                currentProduct.id = productDoc.id;
                console.log('Product loaded successfully:', currentProduct);
                
                await displayProductDetails();
                loadSimilarProducts();
                
                // Increment view count (skip if permission denied)
                try {
                    console.log('Incrementing view count...');
                    await updateDoc(doc(db, 'items', productId), {
                        views: increment(1)
                    });
                    console.log('View count incremented');
                } catch (updateError) {
                    console.log('Could not update view count (permission denied):', updateError.message);
                    // Continue without updating view count
                }
                
            } catch (error) {
                console.error('Error loading product:', error);
                console.error('Error details:', error.message, error.code);
                alert('Error loading product details: ' + error.message);
            }
        }

        async function displayProductDetails() {
            console.log('Displaying product details:', currentProduct);
            
            // Basic product info
            document.getElementById('productName').textContent = currentProduct.title || currentProduct.name;
            document.getElementById('productPrice').textContent = 'GHS ' + currentProduct.price.toFixed(2);
            document.getElementById('productCategory').textContent = currentProduct.category;
            document.getElementById('productCondition').textContent = currentProduct.condition || 'Good';
            document.getElementById('productLocation').textContent = currentProduct.location || 'Location not specified';
            document.getElementById('productViews').textContent = currentProduct.views || 0;
            document.getElementById('productDescription').textContent = currentProduct.description;

            // Badges
            if (currentProduct.urgent) {
                document.getElementById('urgentBadge').classList.remove('hidden');
            }
            if (currentProduct.negotiable) {
                document.getElementById('negotiableBadge').classList.remove('hidden');
            }

            // Load seller profile information
            await loadSellerProfile();

            // Images
            displayProductImages();
        }

        // University mapping for display names
        const universityNames = {
            'university-of-ghana': 'University of Ghana',
            'knust': 'Kwame Nkrumah University of Science and Technology',
            'university-of-cape-coast': 'University of Cape Coast',
            'university-of-education': 'University of Education, Winneba',
            'ashesi-university': 'Ashesi University',
            'central-university': 'Central University',
            'presbyterian-university': 'Presbyterian University',
            'valley-view-university': 'Valley View University',
            'methodist-university': 'Methodist University',
            'other': 'Other University'
        };

        // Load seller profile information from users collection
        async function loadSellerProfile() {
            try {
                console.log('Loading seller profile for sellerId:', currentProduct.sellerId);
                
                if (!currentProduct.sellerId) {
                    console.log('No sellerId found in product data');
                    document.getElementById('sellerName').textContent = 'Unknown Seller';
                    document.getElementById('sellerUniversity').textContent = 'University not specified';
                    document.getElementById('contactInfo').textContent = 'Contact info not available';
                    return;
                }

                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('uid', '==', currentProduct.sellerId));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const sellerProfile = querySnapshot.docs[0].data();
                    console.log('Seller profile loaded:', sellerProfile);
                    console.log('Seller phone:', sellerProfile.phone);
                    console.log('Seller university:', sellerProfile.university);
                    console.log('Seller fullName:', sellerProfile.fullName);
                    
                    // Get display name for university
                    const universityDisplayName = universityNames[sellerProfile.university] || sellerProfile.university || 'University not specified';
                    
                    // Update seller information with profile data
                    document.getElementById('sellerName').textContent = sellerProfile.fullName || currentProduct.sellerName || 'Unknown Seller';
                    document.getElementById('sellerUniversity').textContent = universityDisplayName;
                    document.getElementById('contactInfo').textContent = sellerProfile.phone || 'Contact info not available';
                    
                    // Update currentProduct with seller profile data for contact seller functionality
                    currentProduct.sellerName = sellerProfile.fullName || currentProduct.sellerName;
                    currentProduct.sellerEmail = sellerProfile.email || currentProduct.sellerEmail;
                    currentProduct.university = universityDisplayName;
                    
                } else {
                    console.log('No seller profile found, using product data');
                    // Fallback to product data if seller profile not found
                    document.getElementById('sellerName').textContent = currentProduct.sellerName || 'Unknown Seller';
                    document.getElementById('sellerUniversity').textContent = currentProduct.university || 'University not specified';
                    document.getElementById('contactInfo').textContent = currentProduct.contactInfo || 'Contact info not available';
                }
            } catch (error) {
                console.error('Error loading seller profile:', error);
                // Fallback to product data on error
                document.getElementById('sellerName').textContent = currentProduct.sellerName || 'Unknown Seller';
                document.getElementById('sellerUniversity').textContent = currentProduct.university || 'University not specified';
                document.getElementById('contactInfo').textContent = currentProduct.contactInfo || 'Contact info not available';
            }
        }

        function displayProductImages() {
            const mainImage = document.getElementById('mainImage');
            const thumbnailContainer = document.getElementById('thumbnailContainer');
            
            // Clear existing thumbnails
            thumbnailContainer.innerHTML = '';
            
            console.log('Product imageUrls:', currentProduct.imageUrls);
            
            if (currentProduct.imageUrls && currentProduct.imageUrls.length > 0) {
                // Check if we have actual images or just placeholders
                const hasRealImages = currentProduct.imageUrls.some(url => 
                    !url.includes('placeholder_image') && 
                    (url.startsWith('http') || url.startsWith('data:') || url.startsWith('blob:'))
                );
                
                if (hasRealImages) {
                    // Use actual images
                    mainImage.src = currentProduct.imageUrls[0];
                    mainImage.alt = currentProduct.title || currentProduct.name;
                    
                    currentProduct.imageUrls.forEach((image, index) => {
                        if (!image.includes('placeholder_image')) {
                            const thumbnail = document.createElement('img');
                            thumbnail.src = image;
                            thumbnail.alt = currentProduct.title || currentProduct.name;
                            thumbnail.className = `thumbnail ${index === 0 ? 'active' : ''}`;
                            thumbnail.onclick = () => selectImage(index);
                            thumbnailContainer.appendChild(thumbnail);
                        }
                    });
                } else {
                    // All images are placeholders, show placeholder
                    console.log('All images are placeholders, showing placeholder');
                    showPlaceholderImage();
                }
            } else {
                // No images at all
                console.log('No images found, showing placeholder');
                showPlaceholderImage();
            }
        }

        function showPlaceholderImage() {
            const mainImage = document.getElementById('mainImage');
            const thumbnailContainer = document.getElementById('thumbnailContainer');
            
            mainImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNzUgMTUwSDIyNVYyNTBIMTc1VjE1MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE3NSAxNzVIMjI1VjIwMEgxNzVWMTc1WiIgZmlsbD0iI0U1RTdFQiIvPgo8L3N2Zz4K';
            mainImage.alt = 'No image available';
            thumbnailContainer.innerHTML = '';
        }

        function selectImage(index) {
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail');
            
            mainImage.src = currentProduct.imageUrls[index];
            
            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }

        async function loadSimilarProducts() {
            try {
                const productsRef = collection(db, 'items');
                const q = query(productsRef, 
                    where('category', '==', currentProduct.category),
                    where('isAvailable', '==', true),
                    where('isSold', '==', false)
                );
                const querySnapshot = await getDocs(q);
                
                const similarProducts = querySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(product => product.id !== currentProduct.id)
                    .slice(0, 4);
                
                displaySimilarProducts(similarProducts);
            } catch (error) {
                console.error('Error loading similar products:', error);
            }
        }

        function displaySimilarProducts(products) {
            const container = document.getElementById('similarProducts');
            container.innerHTML = '';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'glass-effect rounded-2xl p-4 shadow-lg hover:shadow-xl transition duration-200 cursor-pointer';
                productCard.onclick = () => window.location.href = `product-details.html?id=${product.id}`;
                
                // Check if we have real images or just placeholders
                let imageHtml = '';
                if (product.imageUrls && product.imageUrls.length > 0) {
                    const hasRealImages = product.imageUrls.some(url => 
                        !url.includes('placeholder_image') && 
                        (url.startsWith('http') || url.startsWith('data:') || url.startsWith('blob:'))
                    );
                    
                    if (hasRealImages) {
                        // Use first real image
                        const firstRealImage = product.imageUrls.find(url => 
                            !url.includes('placeholder_image') && 
                            (url.startsWith('http') || url.startsWith('data:') || url.startsWith('blob:'))
                        );
                        imageHtml = `<img src="${firstRealImage}" alt="${product.title || product.name}" class="w-full h-32 object-cover rounded-lg mb-3">`;
                    } else {
                        // All images are placeholders, show placeholder
                        imageHtml = `<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNzUgMTUwSDIyNVYyNTBIMTc1VjE1MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE3NSAxNzVIMjI1VjIwMEgxNzVWMTc1WiIgZmlsbD0iI0U1RTdFQiIvPgo8L3N2Zz4K" alt="${product.title || product.name}" class="w-full h-32 object-cover rounded-lg mb-3">`;
                    }
                } else {
                    // No images, show placeholder
                    imageHtml = `<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDQwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0xNzUgMTUwSDIyNVYyNTBIMTc1VjE1MFoiIGZpbGw9IiM5Q0EzQUYiLz4KPHBhdGggZD0iTTE3NSAxNzVIMjI1VjIwMEgxNzVWMTc1WiIgZmlsbD0iI0U1RTdFQiIvPgo8L3N2Zz4K" alt="${product.title || product.name}" class="w-full h-32 object-cover rounded-lg mb-3">`;
                }
                
                productCard.innerHTML = `
                    ${imageHtml}
                    <h4 class="font-semibold text-gray-900 truncate">${product.title || product.name}</h4>
                    <p class="text-teal-600 font-bold">GHS ${product.price.toFixed(2)}</p>
                    <p class="text-sm text-gray-500">${product.location}</p>
                `;
                
                container.appendChild(productCard);
            });
        }

        window.placeOrder = function() {
            if (!currentProduct) {
                alert('Product not loaded');
                return;
            }
            
            // Show order confirmation modal
            showOrderModal();
        }
        
        function showOrderModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-semibold mb-4">Place Order</h3>
                    <p class="text-gray-600 mb-4">Are you sure you want to place an order for "${currentProduct.title || currentProduct.name}"?</p>
                    <div class="flex space-x-3">
                        <button onclick="confirmOrder()" class="flex-1 bg-teal-600 text-white py-2 px-4 rounded-lg hover:bg-teal-700">
                            Confirm Order
                        </button>
                        <button onclick="closeOrderModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeOrderModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }
        
        // Make functions globally accessible
        window.closeOrderModal = closeOrderModal;
        
        async function confirmOrder() {
            try {
                if (!currentProduct) {
                    alert('Product not loaded');
                    return;
                }
                
                if (!currentUser) {
                    alert('User not authenticated');
                    return;
                }
                
                // Get buyer contact info from user profile
                const userQuery = query(collection(db, 'users'), where('uid', '==', currentUser.uid));
                const userSnapshot = await getDocs(userQuery);
                let buyerContact = '';
                let buyerLocation = '';
                
                if (!userSnapshot.empty) {
                    const userData = userSnapshot.docs[0].data();
                    buyerContact = userData.phone || '';
                    buyerLocation = userData.university || '';
                }
                
                // Create order data with unique ID
                const orderData = {
                    productId: currentProduct.id,
                    productTitle: currentProduct.title || currentProduct.name,
                    productPrice: currentProduct.price,
                    sellerId: currentProduct.sellerId,
                    sellerName: currentProduct.sellerName,
                    buyerId: currentUser.uid,
                    buyerName: currentUser.displayName || 'Buyer',
                    buyerContact: buyerContact,
                    buyerLocation: buyerLocation,
                    status: 'pending',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                // Save order to Firebase
                const docRef = await addDoc(collection(db, 'orders'), orderData);
                console.log('Order created with ID:', docRef.id);
                
                // Update order data with the generated ID
                orderData.id = docRef.id;
                
                    // Send notification to seller
                    try {
                        // Create in-app notification in Firebase
                        await firebaseNotificationService.createSellerNotification(orderData, currentProduct.sellerId);
                        console.log('Seller notification created in Firebase');
                        
                        // Send email notification (preview)
                        try {
                            const sellerQuery = query(collection(db, 'users'), where('uid', '==', currentProduct.sellerId));
                            const sellerSnapshot = await getDocs(sellerQuery);
                            
                            if (!sellerSnapshot.empty) {
                                const sellerData = sellerSnapshot.docs[0].data();
                                const sellerEmail = sellerData.email;
                                
                                if (sellerEmail) {
                                    await firebaseNotificationService.sendEmailNotification(orderData, sellerEmail);
                                    console.log('Email notification sent to seller');
                                }
                            }
                        } catch (emailError) {
                            console.error('Error sending email notification:', emailError);
                            // Don't fail the order if email fails
                        }
                    } catch (notificationError) {
                        console.error('Error creating seller notification:', notificationError);
                        // Don't fail the order if notification fails
                    }
                
                // Close modal
                closeOrderModal();
                
                // Show success message and redirect to orders
                alert('Order placed successfully! The seller has been notified and will see the order in their dashboard.');
                window.location.href = 'buyer-orders.html';
                
            } catch (error) {
                console.error('Error placing order:', error);
                alert('Error placing order. Please try again.');
            }
        }
        
        // Make confirmOrder globally accessible
        window.confirmOrder = confirmOrder;

        function closeContactModal() {
            document.getElementById('contactModal').classList.add('hidden');
            document.getElementById('contactModal').classList.remove('flex');
        }

        function sendMessage() {
            const message = document.getElementById('messageText').value.trim();
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            // In a real app, you'd send this to a messaging system
            alert('Message sent! The seller will contact you soon.');
            closeContactModal();
        }

        function addToFavorites() {
            // In a real app, you'd add to user's favorites
            alert('Added to favorites!');
        }

        window.goBack = function() {
            window.location.href = 'buyer-dashboard.html';
        }

        // Logout function
        window.logout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }
    </script>
</body>
</html>