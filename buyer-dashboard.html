<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer Dashboard - Unitrade</title>
    <link rel="icon" type="image/png" href="./images/app_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="js/firebase-config-public.js"></script>
    <script src="js/firebase-init.js"></script>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="./images/app_logo.png" alt="Unitrade" class="h-10 w-10 mr-3">
                    <span class="text-2xl font-bold text-teal-800">Unitrade</span>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="buyer-dashboard.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-1"></i>Dashboard
                    </a>
                    <a href="buyer-orders.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-shopping-bag mr-1"></i>My Orders
                    </a>
                    <a href="profile-settings.html" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-user mr-1"></i>Profile
                    </a>
                    <span id="userName" class="text-gray-700 px-3 py-2 text-sm font-medium">Loading...</span>
                    <button onclick="logout()" class="text-gray-700 hover:text-teal-600 px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </button>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-gray-700 hover:text-teal-600 p-2 rounded-md transition-colors duration-200 hover:bg-gray-100">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden transition-all duration-300 ease-in-out">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white/95 backdrop-blur-md rounded-lg mt-2 shadow-xl border border-gray-200">
                    <a href="buyer-dashboard.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="buyer-orders.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-shopping-bag mr-2"></i>My Orders
                    </a>
                    <a href="profile-settings.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-base font-medium">
                        <i class="fas fa-user mr-2"></i>Profile
                    </a>
                    <div class="border-t border-gray-200 pt-2 mt-2">
                        <div class="px-3 py-2">
                            <span id="userNameMobile" class="text-gray-700 text-sm">Loading...</span>
                        </div>
                        <button onclick="logout()" class="text-gray-700 hover:text-teal-600 block w-full text-left px-3 py-2 rounded-md text-base font-medium">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search and Categories -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search products..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
                <button onclick="searchProducts()" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
            </div>
            
            <!-- Categories -->
            <div class="flex flex-wrap gap-2">
                <button class="category-chip active" onclick="filterByCategory('All')">
                    <i class="fas fa-th-large text-sm mr-2"></i>
                    <span>All</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Food & Beverages')">
                    <i class="fas fa-utensils text-sm mr-2"></i>
                    <span>Food & Beverages</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Clothing')">
                    <i class="fas fa-tshirt text-sm mr-2"></i>
                    <span>Clothing</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Accessories')">
                    <i class="fas fa-gem text-sm mr-2"></i>
                    <span>Accessories</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Gadgets & Electronics')">
                    <i class="fas fa-laptop text-sm mr-2"></i>
                    <span>Gadgets & Electronics</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Personal Care & Beauty')">
                    <i class="fas fa-spa text-sm mr-2"></i>
                    <span>Personal Care & Beauty</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Books & Stationery')">
                    <i class="fas fa-book text-sm mr-2"></i>
                    <span>Books & Stationery</span>
                </button>
            </div>
        </div>

        <!-- Featured Items -->
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Featured Items</h2>
            <div id="productsContainer" class="grid md:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let auth, db;
        let allProducts = [];

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (!mobileMenu) {
                console.error('Mobile menu element not found');
                return;
            }
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.style.display = 'block';
            } else {
                mobileMenu.classList.add('hidden');
                mobileMenu.style.display = 'none';
            }
        }

        // Initialize the app
        async function initApp() {
            try {
                console.log('üöÄ Initializing app...');
                
                // Initialize Firebase with fallback
                const firebaseConfig = window.FIREBASE_CONFIG || {
                    apiKey: "AIzaSyBzyKtEKbUMt66t9Sfk_onbOcJNic_t5oc",
                    authDomain: "unitrade-d74e9.firebaseapp.com",
                    projectId: "unitrade-d74e9",
                    storageBucket: "unitrade-d74e9.appspot.com",
                    messagingSenderId: "619229942843",
                    appId: "1:619229942843:web:8eced8b46057a24b04f81e",
                    measurementId: "G-6DPM2BCY97"
                };
                
                let firebaseInit;
                if (window.initializeFirebase) {
                    firebaseInit = await window.initializeFirebase(firebaseConfig);
                } else {
                    // Fallback to direct initialization
                    const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                    const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    
                    let app;
                    if (!getApps().length) {
                        app = initializeApp(firebaseConfig);
                    } else {
                        app = getApp();
                    }
                    firebaseInit = {
                        app: app,
                        auth: getAuth(app),
                        db: getFirestore(app)
                    };
                }
                
                auth = firebaseInit.auth;
                db = firebaseInit.db;
                
                console.log('‚úÖ Firebase initialized');
                
                // Load products immediately
                await loadProducts();
                
                // Set up auth listener
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        const userName = user.displayName || 'Buyer';
                        document.getElementById('userName').textContent = userName;
                        document.getElementById('userNameMobile').textContent = userName;
                    } else {
                        const guestHtml = `
                            <span class="text-gray-600">Guest User</span>
                            <a href="buyer-login.html" class="ml-2 bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700">
                                Login to Order
                            </a>
                        `;
                        document.getElementById('userName').innerHTML = guestHtml;
                        document.getElementById('userNameMobile').innerHTML = 'Guest User';
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showError('Failed to initialize app: ' + error.message);
            }
        }

        // Load products
        async function loadProducts() {
            try {
                console.log('üîÑ Loading products...');
                
                // Import Firebase functions
                const { collection, getDocs, query, orderBy } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Query with ordering by createdAt descending (newest first)
                const productsRef = collection(db, 'items');
                const q = query(productsRef, orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                console.log('üìä Found', snapshot.size, 'items');
                
                allProducts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üì¶ Product data:', doc.id, {
                        title: data.title,
                        imageUrl: data.imageUrl,
                        imageUrls: data.imageUrls,
                        hasImages: !!(data.imageUrl || (data.imageUrls && data.imageUrls.length > 0)),
                        createdAt: data.createdAt
                    });
                    allProducts.push({ id: doc.id, ...data });
                });
                
                // Sort by createdAt descending (newest first) as fallback
                allProducts.sort((a, b) => {
                    const timestampA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const timestampB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return timestampB - timestampA;
                });
                
                console.log('üìÖ Products sorted by newest first');
                displayProducts(allProducts);
                
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                showError('Failed to load products: ' + error.message);
            }
        }

        // Display products
        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
                        <p class="text-gray-500">Check back later for new listings!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(product => {
                // Handle images - check for imageUrls array first, then imageUrl
                let imageHtml = '';
                if (product.imageUrls && product.imageUrls.length > 0) {
                    imageHtml = `<img src="${product.imageUrls[0]}" alt="${product.title || 'Product'}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
                } else if (product.imageUrl) {
                    imageHtml = `<img src="${product.imageUrl}" alt="${product.title || 'Product'}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
                }
                
                return `
                    <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition duration-300 cursor-pointer product-card" 
                         data-category="${product.category || 'Uncategorized'}"
                         onclick="viewProduct('${product.id}')">
                        ${imageHtml}
                        <div class="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center" style="display: ${imageHtml ? 'none' : 'flex'};">
                            <i class="fas fa-image text-4xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.title || 'Untitled Item'}</h3>
                        <p class="text-sm text-gray-500 mb-2">${product.category || 'Uncategorized'}</p>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description || 'No description available'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-teal-600">GHS ${product.price || 0}</span>
                            <span class="text-sm text-gray-500">${product.paymentMethod || 'Momo'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View product
        function viewProduct(productId) {
            window.location.href = `product-details.html?id=${productId}`;
        }

        // Search products
        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProducts.filter(product => 
                (product.title || '').toLowerCase().includes(searchTerm) ||
                (product.description || '').toLowerCase().includes(searchTerm)
            );
            
            // Sort filtered results by newest first
            filtered.sort((a, b) => {
                const timestampA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const timestampB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return timestampB - timestampA;
            });
            
            displayProducts(filtered);
        }

        // Filter by category
        function filterByCategory(category) {
            // Update active category
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.closest('.category-chip').classList.add('active');
            
            // Filter products
            let filtered = allProducts;
            if (category !== 'All') {
                filtered = allProducts.filter(product => product.category === category);
            }
            
            // Sort filtered results by newest first
            filtered.sort((a, b) => {
                const timestampA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const timestampB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return timestampB - timestampA;
            });
            
            displayProducts(filtered);
        }

        // Logout
        function logout() {
            if (auth) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            } else {
                window.location.href = 'index.html';
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('productsContainer').innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Error</h3>
                    <p class="text-gray-500">${message}</p>
                </div>
            `;
        }

        // Start the app
        initApp();
    </script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, rgba(0, 77, 64, 0.08) 0%, rgba(20, 184, 166, 0.1) 100%);
        }
        
        .category-chip {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #6b7280;
        }
        
        .category-chip:hover {
            border-color: #14b8a6;
            color: #14b8a6;
        }
        
        .category-chip.active {
            background: #14b8a6;
            border-color: #14b8a6;
            color: white;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</body>
</html>
