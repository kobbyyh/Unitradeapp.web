<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer Dashboard - Unitrade</title>
    <link rel="icon" type="image/png" href="./images/app_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="js/firebase-config-public.js"></script>
    <script src="js/firebase-init.js"></script>
    <style>
        /* Ensure dropdown menus work properly */
        .group:hover .group-hover\:block {
            display: block;
        }
        
        /* Tablet menu styling */
        #tabletMenu {
            transition: all 0.2s ease;
        }
        
        /* Responsive navigation adjustments */
        @media (max-width: 1024px) {
            .hidden.lg\:flex {
                display: none !important;
            }
        }
        
        @media (max-width: 768px) {
            .hidden.md\:flex {
                display: none !important;
            }
        }
        
        /* Compact navigation styling */
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background-color: rgba(13, 148, 136, 0.1);
        }
        
        /* University filter styling */
        .university-filter {
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }
        
        .university-filter:hover {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .university-filter.active {
            background-color: #0d9488;
            color: white;
            border-color: #0d9488;
        }
        
        .university-filter.active:hover {
            background-color: #0f766e;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <img src="./images/app_logo.png" alt="Unitrade" class="h-10 w-10 mr-3">
                    <span class="text-2xl font-bold text-teal-800">Unitrade</span>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden lg:flex items-center space-x-2">
                    <a href="buyer-dashboard.html" class="text-gray-700 hover:text-teal-600 px-2 py-2 rounded-md text-xs font-medium">
                        <i class="fas fa-home mr-1"></i>Dashboard
                    </a>
                    <a href="buyer-orders.html" class="text-gray-700 hover:text-teal-600 px-2 py-2 rounded-md text-xs font-medium">
                        <i class="fas fa-shopping-bag mr-1"></i>Orders
                    </a>
                    <a href="seller-dashboard.html" class="text-gray-700 hover:text-teal-600 px-2 py-2 rounded-md text-xs font-medium">
                        <i class="fas fa-store mr-1"></i>Sell
                    </a>
                    <div class="relative group">
                        <button class="text-gray-700 hover:text-teal-600 px-2 py-2 rounded-md text-xs font-medium flex items-center">
                            <i class="fas fa-user mr-1"></i>Profile
                            <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden group-hover:block">
                            <a href="profile-settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </a>
                            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </div>
                    <span id="userName" class="text-gray-600 px-2 py-2 text-xs font-medium">Loading...</span>
                </div>

                <!-- Medium screen navigation (tablet) -->
                <div class="hidden md:flex lg:hidden items-center space-x-1">
                    <a href="buyer-dashboard.html" class="text-gray-700 hover:text-teal-600 px-1 py-2 rounded-md text-xs font-medium">
                        <i class="fas fa-home"></i>
                    </a>
                    <a href="buyer-orders.html" class="text-gray-700 hover:text-teal-600 px-1 py-2 rounded-md text-xs font-medium">
                        <i class="fas fa-shopping-bag"></i>
                    </a>
                    <a href="seller-dashboard.html" class="text-gray-700 hover:text-teal-600 px-1 py-2 rounded-md text-xs font-medium">
                        <i class="fas fa-store"></i>
                    </a>
                    <div class="relative">
                        <button onclick="toggleTabletMenu()" class="text-gray-700 hover:text-teal-600 px-1 py-2 rounded-md text-xs font-medium">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div id="tabletMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                            <a href="profile-settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-cog mr-2"></i>Settings
                            </a>
                            <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button onclick="toggleMobileMenu()" class="text-gray-700 hover:text-teal-600 p-2 rounded-md transition-colors duration-200 hover:bg-gray-100">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden transition-all duration-300 ease-in-out">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white/95 backdrop-blur-md rounded-lg mt-2 shadow-xl border border-gray-200">
                    <a href="buyer-dashboard.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <a href="buyer-orders.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-shopping-bag mr-2"></i>My Orders
                    </a>
                    <a href="seller-dashboard.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-store mr-2"></i>Seller Dashboard
                    </a>
                    <a href="profile-settings.html" class="text-gray-700 hover:text-teal-600 block px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                    <div class="border-t border-gray-200 pt-2 mt-2">
                        <div class="px-3 py-2">
                            <span id="userNameMobile" class="text-gray-700 text-xs">Loading...</span>
                        </div>
                        <button onclick="logout()" class="text-gray-700 hover:text-teal-600 block w-full text-left px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search and Categories -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search products..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                </div>
                <button onclick="searchProducts()" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
            </div>
            
            <!-- University Filter -->
            <div class="mb-6">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-700">Filter by University:</span>
                    <div class="flex gap-2">
                        <button id="myUniversityBtn" onclick="filterByUniversity('my')" 
                                class="university-filter active px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-university mr-2"></i>My University
                        </button>
                        <button id="allUniversitiesBtn" onclick="filterByUniversity('all')" 
                                class="university-filter px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-globe mr-2"></i>All Universities
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Categories -->
            <div class="flex flex-wrap gap-2">
                <button class="category-chip active" onclick="filterByCategory('All')">
                    <i class="fas fa-th-large text-sm mr-2"></i>
                    <span>All</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Food & Beverages')">
                    <i class="fas fa-utensils text-sm mr-2"></i>
                    <span>Food & Beverages</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Clothing')">
                    <i class="fas fa-tshirt text-sm mr-2"></i>
                    <span>Clothing</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Accessories')">
                    <i class="fas fa-gem text-sm mr-2"></i>
                    <span>Accessories</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Gadgets & Electronics')">
                    <i class="fas fa-laptop text-sm mr-2"></i>
                    <span>Gadgets & Electronics</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Personal Care & Beauty')">
                    <i class="fas fa-spa text-sm mr-2"></i>
                    <span>Personal Care & Beauty</span>
                </button>
                <button class="category-chip" onclick="filterByCategory('Books & Stationery')">
                    <i class="fas fa-book text-sm mr-2"></i>
                    <span>Books & Stationery</span>
                </button>
            </div>
        </div>

        <!-- Featured Items -->
        <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Featured Items</h2>
            <div id="productsContainer" class="grid md:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">Loading products...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let auth, db;
        let allProducts = [];
        let currentUserUniversity = '';
        let currentUniversityFilter = 'my'; // 'my' or 'all'

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (!mobileMenu) {
                console.error('Mobile menu element not found');
                return;
            }
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                mobileMenu.style.display = 'block';
            } else {
                mobileMenu.classList.add('hidden');
                mobileMenu.style.display = 'none';
            }
        }

        // Tablet menu toggle function
        function toggleTabletMenu() {
            const tabletMenu = document.getElementById('tabletMenu');
            if (!tabletMenu) {
                console.error('Tablet menu element not found');
                return;
            }
            
            if (tabletMenu.classList.contains('hidden')) {
                tabletMenu.classList.remove('hidden');
            } else {
                tabletMenu.classList.add('hidden');
            }
        }

        // Close tablet menu when clicking outside
        document.addEventListener('click', function(event) {
            const tabletMenu = document.getElementById('tabletMenu');
            const tabletButton = event.target.closest('button[onclick="toggleTabletMenu()"]');
            
            if (tabletMenu && !tabletMenu.contains(event.target) && !tabletButton) {
                tabletMenu.classList.add('hidden');
            }
        });

        // Check user type from Firestore
        async function checkUserType(user) {
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', user.email));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userData = querySnapshot.docs[0].data();
                    // All users are buyers by default, allow access
                    const userName = user.displayName || userData.fullName || 'Buyer';
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userNameMobile').textContent = userName;
                    
                    // Store user's university for filtering
                    currentUserUniversity = userData.university || userData.sellerUniversity || '';
                    console.log('User authenticated as buyer:', userName, 'University:', currentUserUniversity);
                    
                    // Load products after successful authentication
                    await loadProducts();
                    
                    // Set up real-time search
                    setupSearchListener();
                } else {
                    // User not found in database, redirect to login
                    console.log('User not found in database, redirecting to login');
                    window.location.href = 'buyer-login.html';
                }
            } catch (error) {
                console.error('Error checking user type:', error);
                window.location.href = 'buyer-login.html';
            }
        }

        // Initialize the app
        async function initApp() {
            try {
                console.log('üöÄ Initializing app...');
                
                // Initialize Firebase with fallback
                const firebaseConfig = window.FIREBASE_CONFIG || {
                    apiKey: "AIzaSyBzyKtEKbUMt66t9Sfk_onbOcJNic_t5oc",
                    authDomain: "unitrade-d74e9.firebaseapp.com",
                    projectId: "unitrade-d74e9",
                    storageBucket: "unitrade-d74e9.appspot.com",
                    messagingSenderId: "619229942843",
                    appId: "1:619229942843:web:8eced8b46057a24b04f81e",
                    measurementId: "G-6DPM2BCY97"
                };
                
                let firebaseInit;
                if (window.initializeFirebase) {
                    firebaseInit = await window.initializeFirebase(firebaseConfig);
                } else {
                    // Fallback to direct initialization
                    const { initializeApp, getApps, getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                    const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                    const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    
                    let app;
                    if (!getApps().length) {
                        app = initializeApp(firebaseConfig);
                    } else {
                        app = getApp();
                    }
                    firebaseInit = {
                        app: app,
                        auth: getAuth(app),
                        db: getFirestore(app)
                    };
                }
                
                auth = firebaseInit.auth;
                db = firebaseInit.db;
                
                console.log('‚úÖ Firebase initialized');
                
                // Set up auth listener
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        // Check if user is a buyer
                        checkUserType(user);
                    } else {
                        // Redirect to login if not authenticated
                        console.log('No user authenticated, redirecting to login');
                        window.location.href = 'buyer-login.html';
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showError('Failed to initialize app: ' + error.message);
            }
        }

        // Load products
        async function loadProducts() {
            try {
                console.log('üîÑ Loading products...');
                
                // Import Firebase functions
                const { collection, getDocs, query, orderBy } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Query with ordering by createdAt descending (newest first)
                const productsRef = collection(db, 'items');
                const q = query(productsRef, orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                
                console.log('üìä Found', snapshot.size, 'items');
                
                allProducts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üì¶ Product data:', doc.id, {
                        title: data.title,
                        imageUrl: data.imageUrl,
                        imageUrls: data.imageUrls,
                        hasImages: !!(data.imageUrl || (data.imageUrls && data.imageUrls.length > 0)),
                        createdAt: data.createdAt
                    });
                    allProducts.push({ id: doc.id, ...data });
                });
                
                // Sort by createdAt descending (newest first) as fallback
                allProducts.sort((a, b) => {
                    const timestampA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                    const timestampB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                    return timestampB - timestampA;
                });
                
                console.log('üìÖ Products sorted by newest first');
                displayProducts(allProducts);
                
            } catch (error) {
                console.error('‚ùå Error loading products:', error);
                showError('Failed to load products: ' + error.message);
            }
        }

        // Display products
        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
                        <p class="text-gray-500">Check back later for new listings!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = products.map(product => {
                // Handle images - check for imageUrls array first, then imageUrl
                let imageHtml = '';
                if (product.imageUrls && product.imageUrls.length > 0) {
                    imageHtml = `<img src="${product.imageUrls[0]}" alt="${product.title || 'Product'}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
                } else if (product.imageUrl) {
                    imageHtml = `<img src="${product.imageUrl}" alt="${product.title || 'Product'}" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
                }
                
                return `
                    <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition duration-300 cursor-pointer product-card" 
                         data-category="${product.category || 'Uncategorized'}"
                         onclick="viewProduct('${product.id}')">
                        ${imageHtml}
                        <div class="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center" style="display: ${imageHtml ? 'none' : 'flex'};">
                            <i class="fas fa-image text-4xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.title || 'Untitled Item'}</h3>
                        <p class="text-sm text-gray-500 mb-2">${product.category || 'Uncategorized'}</p>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description || 'No description available'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-teal-600">GHS ${product.price || 0}</span>
                            <span class="text-sm text-gray-500">${product.paymentMethod || 'Momo'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View product
        function viewProduct(productId) {
            window.location.href = `product-details.html?id=${productId}`;
        }

        // Search products
        function searchProducts() {
            applyFilters();
        }

        // Filter by category
        function filterByCategory(category) {
            // Update active category
            document.querySelectorAll('.category-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.closest('.category-chip').classList.add('active');
            
            // Apply all filters
            applyFilters();
        }

        // Filter by university
        function filterByUniversity(filterType) {
            currentUniversityFilter = filterType;
            
            // Update active university filter button
            document.querySelectorAll('.university-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (filterType === 'my') {
                document.getElementById('myUniversityBtn').classList.add('active');
            } else {
                document.getElementById('allUniversitiesBtn').classList.add('active');
            }
            
            // Apply university filter
            applyFilters();
        }

        // Apply all active filters
        function applyFilters() {
            let filtered = allProducts;
            
            // Apply university filter
            if (currentUniversityFilter === 'my' && currentUserUniversity) {
                console.log('üîç Filtering by university:', currentUserUniversity);
                console.log('üîç Products before filter:', filtered.length);
                filtered = filtered.filter(product => {
                    const matches = product.university === currentUserUniversity;
                    if (!matches) {
                        console.log('‚ùå Product filtered out:', product.title, 'University:', product.university);
                    }
                    return matches;
                });
                console.log('üîç Products after filter:', filtered.length);
            } else if (currentUniversityFilter === 'all') {
                console.log('üåç Showing all universities');
            }
            
            // Apply category filter
            const activeCategory = document.querySelector('.category-chip.active');
            if (activeCategory) {
                const category = activeCategory.textContent.trim();
                if (category !== 'All') {
                    filtered = filtered.filter(product => product.category === category);
                }
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(product => 
                    product.title.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sort filtered results by newest first
            filtered.sort((a, b) => {
                const timestampA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const timestampB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return timestampB - timestampA;
            });
            
            displayProducts(filtered);
        }

        // Set up real-time search listener
        function setupSearchListener() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    applyFilters();
                });
            }
        }

        // Logout
        function logout() {
            if (auth) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            } else {
                window.location.href = 'index.html';
            }
        }

        // Show error
        function showError(message) {
            document.getElementById('productsContainer').innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Error</h3>
                    <p class="text-gray-500">${message}</p>
                </div>
            `;
        }

        // Start the app
        initApp();
    </script>

    <style>
        .gradient-bg {
            background: linear-gradient(135deg, rgba(0, 77, 64, 0.08) 0%, rgba(20, 184, 166, 0.1) 100%);
        }
        
        .category-chip {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #6b7280;
        }
        
        .category-chip:hover {
            border-color: #14b8a6;
            color: #14b8a6;
        }
        
        .category-chip.active {
            background: #14b8a6;
            border-color: #14b8a6;
            color: white;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</body>
</html>
