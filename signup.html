<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signup - Unitrade</title>
    <link rel="icon" type="image/png" href="./images/app_logo.png">
    <link rel="shortcut icon" type="image/png" href="./images/app_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, rgba(0, 77, 64, 0.08) 0%, rgba(20, 184, 166, 0.1) 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .role-option {
            transition: all 0.3s ease;
        }
        .role-option.selected {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
            color: white;
            transform: scale(1.02);
        }
        .role-option:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-8">
    <div class="max-w-2xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <img src="./images/app_logo.png" alt="Unitrade" class="h-16 w-16 mx-auto mb-4">
            <h1 class="text-3xl font-bold text-gray-900">Join Unitrade</h1>
            <p class="text-gray-600 mt-2">Create your buyer account - you can also sell later!</p>
        </div>

        <!-- Signup Form -->
        <div class="glass-effect rounded-3xl p-8 shadow-xl">
            <form id="signupForm" class="space-y-6">

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user text-teal-600 mr-2"></i>
                            Full Name
                        </label>
                        <input type="text" id="fullName" name="fullName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                               placeholder="As per your school ID">
                    </div>

                    <div>
                        <label for="studentId" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-id-card text-teal-600 mr-2"></i>
                            Student ID Number
                        </label>
                        <input type="text" id="studentId" name="studentId" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                               placeholder="Your student ID">
                    </div>
                </div>

                <div>
                    <label for="university" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-university text-teal-600 mr-2"></i>
                        University
                    </label>
                    <select id="university" name="university" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200">
                        <option value="">Select your university</option>
                        <option value="university-of-ghana">University of Ghana</option>
                        <option value="knust">Kwame Nkrumah University of Science and Technology</option>
                        <option value="university-of-cape-coast">University of Cape Coast</option>
                        <option value="university-of-education">University of Education, Winneba</option>
                        <option value="ashesi-university">Ashesi University</option>
                        <option value="central-university">Central University</option>
                        <option value="presbyterian-university">Presbyterian University</option>
                        <option value="valley-view-university">Valley View University</option>
                        <option value="methodist-university">Methodist University</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope text-teal-600 mr-2"></i>
                        University Email
                    </label>
                    <input type="email" id="email" name="email" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                           placeholder="your.email@university.edu">
                    <p class="text-sm text-gray-500 mt-1">Must be a valid university email address</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-phone text-teal-600 mr-2"></i>
                            Phone Number
                        </label>
                        <input type="tel" id="phone" name="phone" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                               placeholder="Your phone number">
                    </div>

                    <div>
                        <label for="hostel" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-home text-teal-600 mr-2"></i>
                            Hostel
                        </label>
                        <input type="text" id="hostel" name="hostel" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                               placeholder="Your hostel name">
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock text-teal-600 mr-2"></i>
                            Password
                        </label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                               placeholder="Create a strong password">
                    </div>

                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock text-teal-600 mr-2"></i>
                            Confirm Password
                        </label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-transparent transition duration-200"
                               placeholder="Confirm password">
                    </div>
                </div>

                <div class="flex items-start">
                    <input type="checkbox" id="terms" name="terms" required
                           class="mt-1 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded">
                    <label for="terms" class="ml-2 text-sm text-gray-700">
                        I agree to the <a href="#" class="text-teal-600 hover:text-teal-800">Terms & Conditions</a> and <a href="#" class="text-teal-600 hover:text-teal-800">Privacy Policy</a>
                    </label>
                </div>

                <button type="submit" 
                        class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-xl transition duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-user-plus mr-2"></i>
                    Create Buyer Account
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600">Already have an account?</p>
                <div class="space-x-4">
                    <a href="buyer-login.html" class="text-teal-600 hover:text-teal-800 font-medium">
                        Login as Buyer
                    </a>
                    <span class="text-gray-400">|</span>
                    <a href="seller-login.html" class="text-teal-600 hover:text-teal-800 font-medium">
                        Login as Seller
                    </a>
                </div>
                <p class="text-sm text-gray-500 mt-2">Same credentials work for both buyer and seller login!</p>
            </div>
        </div>

        <!-- Back to Home -->
        <div class="text-center mt-6">
            <a href="index.html" class="text-gray-600 hover:text-teal-600">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Home
            </a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzyKtEKbUMt66t9Sfk_onbOcJNic_t5oc",
            authDomain: "unitrade-d74e9.firebaseapp.com",
            projectId: "unitrade-d74e9",
            storageBucket: "unitrade-d74e9.firebasestorage.app",
            messagingSenderId: "619229942843",
            appId: "1:619229942843:web:8eced8b46057a24b04f81e",
            measurementId: "G-6DPM2BCY97"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check if user is already logged in
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Only redirect if email is verified
                if (user.emailVerified) {
                    // Redirect based on user type - this will be handled after account creation
                    window.location.href = 'buyer-dashboard.html';
                }
            }
        });


        // Handle signup form submission
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const fullName = formData.get('fullName');
            const studentId = formData.get('studentId');
            const university = formData.get('university');
            const email = formData.get('email');
            const phone = formData.get('phone');
            const hostel = formData.get('hostel');
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            const terms = formData.get('terms');
            
            // Debug logging
            console.log('Form data submitted:', {
                fullName,
                studentId,
                university,
                email,
                phone,
                hostel,
                password: password ? '***' : 'MISSING',
                terms
            });
            
            // Password validation
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            // Basic validation
            if (!fullName || !studentId || !university || !email || !phone || !hostel || !password || !terms) {
                console.log('Validation failed - missing fields:', {
                    fullName: !!fullName,
                    studentId: !!studentId,
                    university: !!university,
                    email: !!email,
                    phone: !!phone,
                    hostel: !!hostel,
                    password: !!password,
                    terms: !!terms
                });
                alert('Please fill in all fields and accept the terms');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // University validation
            if (university === '') {
                alert('Please select your university');
                return;
            }
            
            const button = this.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Checking email...';
            button.disabled = true;
            
            try {
                // Update button text
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Account...';
                
                console.log('Starting Firebase operations...');
                console.log('Creating user with email:', email);
                
                let userCredential;
                let user;
                
                try {
                    // Try to create user with Firebase Auth
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    user = userCredential.user;
                    console.log('New user created in Firebase Auth');
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        // Email already exists in Firebase Auth, check if user exists in Firestore
                        console.log('Email already exists in Firebase Auth, checking Firestore...');
                        
                        const { query, collection, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        const userQuery = query(collection(db, 'users'), where('email', '==', email));
                        const userSnapshot = await getDocs(userQuery);
                        
                        if (!userSnapshot.empty) {
                            alert('This email is already registered. Please use a different email or try logging in.');
                            button.innerHTML = originalText;
                            button.disabled = false;
                            return;
                        } else {
                            // Email exists in Auth but not in Firestore - this is an orphaned account
                            // Try to sign in with the existing password to recover the account
                            console.log('Attempting to recover orphaned account...');
                            
                            try {
                                const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                                userCredential = await signInWithEmailAndPassword(auth, email, password);
                                user = userCredential.user;
                                console.log('Successfully recovered orphaned account');
                                
                                // Continue with creating Firestore document for this recovered account
                            } catch (signInError) {
                                if (signInError.code === 'auth/wrong-password') {
                                    alert('This email is already registered but the password is incorrect. Please use the correct password to login or use a different email address.');
                                } else {
                                    alert('This email is already registered in our system but there was an error recovering the account. Please try logging in or use a different email address.');
                                }
                                button.innerHTML = originalText;
                                button.disabled = false;
                                return;
                            }
                        }
                    } else {
                        // Other auth errors, re-throw them
                        throw authError;
                    }
                }
                console.log('User created/recovered successfully:', user.uid);
                
                // Check if user already has a Firestore document
                const { query, collection, where, getDocs, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const existingUserQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
                const existingUserSnapshot = await getDocs(existingUserQuery);
                
                if (!existingUserSnapshot.empty) {
                    console.log('User already has Firestore document, updating...');
                    // User already exists in Firestore, update their data
                    const userDoc = existingUserSnapshot.docs[0];
                    const userData = {
                        fullName: fullName,
                        studentId: studentId,
                        university: university,
                        email: email,
                        phone: phone,
                        hostel: hostel,
                        userType: 'buyer', // Ensure they're set as buyer
                        updatedAt: serverTimestamp()
                    };
                    
                    await updateDoc(userDoc.ref, userData);
                    console.log('User data updated in Firestore');
                } else {
                    console.log('Creating new Firestore document...');
                    // Send email verification using Firebase
                    console.log('Sending email verification...');
                    await sendEmailVerification(user);
                    console.log('Email verification sent');
                    
                    // Prepare user data for Firestore
                    const userData = {
                        uid: user.uid,
                        fullName: fullName,
                        studentId: studentId,
                        university: university,
                        email: email,
                        phone: phone,
                        hostel: hostel,
                        userType: 'buyer', // All users are buyers by default
                        emailVerified: false,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    };
                    
                    console.log('Saving user data to Firestore:', userData);
                    
                    // Save user data to Firestore
                    const docRef = await addDoc(collection(db, 'users'), userData);
                    console.log('User data saved to Firestore with ID:', docRef.id);
                }
                
                // Update user profile
                console.log('Updating user profile...');
                await updateProfile(user, {
                    displayName: fullName
                });
                console.log('User profile updated');
                
                console.log('Buyer account created successfully:', user);
                alert('Buyer account created successfully! You can now login as both buyer and seller. Please check your email for verification.');
                window.location.href = 'email-verification.html';
                
            } catch (error) {
                console.error('Signup error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Full error object:', JSON.stringify(error, null, 2));
                
                let errorMessage = 'Account creation failed. Please try again.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'An account with this email already exists.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password should be at least 6 characters.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address.';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Email/password accounts are not enabled. Please contact support.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your internet connection.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many requests. Please try again later.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                    default:
                        errorMessage = `Account creation failed: ${error.message}`;
                        break;
                }
                
                alert(`Error: ${errorMessage}\n\nError Code: ${error.code}\n\nPlease check the console for more details.`);
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
        
        // University selection handler
        document.getElementById('university').addEventListener('change', function() {
            const selectedUniversity = this.value;
            const emailInput = document.getElementById('email');
            
            // Update email placeholder based on university selection
            const universityDomains = {
                'university-of-ghana': 'ug.edu.gh',
                'knust': 'knust.edu.gh',
                'university-of-cape-coast': 'ucc.edu.gh',
                'university-of-education': 'uew.edu.gh',
                'ashesi-university': 'ashesi.edu.gh',
                'central-university': 'central.edu.gh',
                'presbyterian-university': 'presbyuniversity.edu.gh',
                'valley-view-university': 'vvu.edu.gh',
                'methodist-university': 'methodistuniversity.edu.gh'
            };
            
            if (universityDomains[selectedUniversity]) {
                emailInput.placeholder = `your.email@${universityDomains[selectedUniversity]}`;
            } else {
                emailInput.placeholder = 'your.email@university.edu';
            }
        });
    </script>
</body>
</html>
